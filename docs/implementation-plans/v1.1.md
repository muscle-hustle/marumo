# marumo 実装計画 v1.1: モザイク・ぼかし強度調整機能

## 概要

モザイクとぼかしの強度を1-10の範囲で調整できる機能を追加します。
強度変更時にはリアルタイムでプレビューが更新されます。

**完了日**: 2025-01-XX（実装完了）

## 影響範囲

### 既存コンポーネント
- [x] `ProcessingOptions.tsx` - 強度調整スライダーの追加
- [x] `App.tsx` - 強度の状態管理とリアルタイムプレビュー処理

### 既存サービス
- [x] `ImageProcessorService` - 強度パラメータを受け取るように変更
  - [x] `applyMosaic()` メソッドに `intensity` パラメータを追加
  - [x] `applyBlur()` メソッドに `intensity` パラメータを追加

### 型定義
- [ ] `src/types/index.ts` - 強度の型定義（必要に応じて）

### ドキュメント
- [x] `00_requirements.md` - 既に強度調整機能の要件が記載済み
- [x] `01_technical-specification.md` - 既に強度調整機能の仕様が記載済み
- [x] `02_api-specification.md` - 既に強度パラメータの説明が記載済み
- [x] `03_user-guide.md` - 既に強度調整機能の使い方が記載済み

## 実装ステップ

### STEP 1: 型定義と状態管理の準備
- [x] `App.tsx`に強度の状態を追加（デフォルト: 5）
  - [x] `const [intensity, setIntensity] = useState<number>(5)`
- [x] 強度の範囲を定数として定義（1-10）

### STEP 2: ImageProcessorServiceの修正
- [x] `applyMosaic()` メソッドのシグネチャを変更
  - [x] 変更後: `applyMosaic(canvas, faces, originalImage, intensity?: number)`
  - [x] デフォルト値: `intensity = 5`
  - [x] 固定値 `MOSAIC_INTENSITY` を削除し、パラメータを使用
- [x] `applyBlur()` メソッドのシグネチャを変更
  - [x] 変更後: `applyBlur(canvas, faces, originalImage, intensity?: number)`
  - [x] デフォルト値: `intensity = 5`
  - [x] 固定値 `BLUR_INTENSITY` を削除し、パラメータを使用
- [x] グリッドサイズ計算式の確認
  - [x] モザイク: `グリッドサイズ = 顔領域の最小辺 / (15 - intensity * 1.5)`
  - [x] 強度が低いほど細かいモザイク（元の顔が見えやすい）
  - [x] 強度が高いほど粗いモザイク（元の顔が見えにくい）
- [x] ブラー半径計算式の確認
  - [x] ぼかし: `ブラー半径 = 2 + intensity * 1.5px`
  - [x] 強度1: ブラー半径 = 3.5px（弱いぼかし）
  - [x] 強度5: ブラー半径 = 9.5px（強いぼかし）

### STEP 3: ProcessingOptionsコンポーネントの実装
- [x] 強度調整スライダーのUIを追加
  - [x] モザイクまたはぼかしが選択されている場合のみ表示
  - [x] スタンプ選択時は非表示
- [x] スライダーのプロパティ
  - [x] 範囲: 1-10
  - [x] デフォルト値: 5
  - [x] ステップ: 1
  - [x] ラベル: 「強度: {value}」
- [x] `onIntensityChange` コールバックの実装
- [x] レスポンシブ対応（スマートフォンでも操作しやすいサイズ）

### STEP 4: App.tsxの統合
- [x] 強度の状態管理を追加
- [x] `ProcessingOptions` に `intensity` と `onIntensityChange` を渡す
- [x] 強度変更時のリアルタイムプレビュー処理
  - [x] `useEffect` で強度変更を監視
  - [x] 強度変更時に自動的に再加工を実行
  - [ ] デバウンス処理（必要に応じて）- 現時点では不要と判断
- [x] `applyImageProcessing()` 呼び出し時に強度を渡す

### STEP 5: テストと動作確認
- [x] モザイク強度の変更が正しく反映されることを確認
- [x] ぼかし強度の変更が正しく反映されることを確認
- [x] スタンプ選択時は強度スライダーが非表示になることを確認
- [x] リアルタイムプレビューが正常に動作することを確認
- [x] スマートフォンでの操作が問題ないことを確認
- [x] パフォーマンステスト（強度変更時の処理速度）

### STEP 6: ドキュメント更新
- [x] 実装完了後、ドキュメントとの整合性を確認
- [x] 必要に応じて実装詳細を更新

## リスク

### パフォーマンスリスク
- **リスク**: 強度変更のたびにリアルタイムで再加工すると、パフォーマンスが低下する可能性
- **対策**: 
  - デバウンス処理を実装（例: 300ms）
  - 大きな画像の場合は処理を最適化
  - 必要に応じて処理を非同期化

### UI/UXリスク
- **リスク**: スライダーの操作が煩雑になる可能性
- **対策**: 
  - スライダーのサイズと操作性を最適化
  - スマートフォンでも操作しやすいUIを設計
  - 現在の強度値を明確に表示

### 互換性リスク
- **リスク**: 既存のコードで `ImageProcessorService` を直接呼び出している箇所がある場合、エラーが発生する可能性
- **対策**: 
  - 既存の呼び出し箇所をすべて確認
  - デフォルト値を設定することで後方互換性を維持

### テストリスク
- **リスク**: 強度の範囲外の値が渡される可能性
- **対策**: 
  - 型定義で範囲を制限
  - バリデーション処理を追加
  - エラーハンドリングを実装

## 実装完了

- [x] すべてのステップが完了
- [x] テストが完了
- [x] ドキュメントが更新済み
- [x] コードレビューが完了
- [x] 本番環境へのデプロイ準備完了
